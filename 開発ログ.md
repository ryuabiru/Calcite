# プロジェクト「Calcite」開発ログ (2025/08/23更新)

## 1. このプロジェクトで実装したいこと

- **直感的な操作性**: `Mito`や`GraphPad Prism`のように、プログラミング知識がなくてもGUI操作だけでデータハンドリング、統計解析、グラフ作成が完結するアプリケーションを目指す。
- **統合環境**: データのインポート、表計算、統計解析、グラフ描画、結果のエクスポートといった一連のワークフローを、シームレスに一つのウィンドウで提供する。
- **論文品質のグラフ**: ユーザーがタイトル、ラベル、色、エラーバーなどを自由に編集でき、学術論文やプレゼンテーションにそのまま利用できる高品質なグラフを作成できる機能。

---

## 2. これまでに実装してきたこと

- **基本UI/UXの改善**
  - **レイアウト変更**: プロパティパネルを画面下部に配置し、データテーブルとグラフの表示領域を拡大。**メインウィンドウを上下分割する`QSplitter`を導入し、起動時のプロパティパネルの高さを最適化**しました。
  - **タブUIの導入**: プロパティパネルを「データ」「フォーマット」「テキスト」「軸」のタブに分割し、設定項目を整理してアクセス性を向上。
  - **高DPI対応**: アプリケーション全体で高解像度ディスプレイをサポートし、グラフやフォントが鮮明に表示されるように改善。

- **データハンドリング機能**
  - **CSVファイルのインポート**: メニューバーからCSVを読み込み、`Pandas`データフレームとして内部で保持。
  - **クリップボードからのペースト**: Excelなどからコピーしたタブ区切りデータをアプリケーションに直接貼り付ける機能を追加 (`Edit` > `Paste`)。
  - **テーブル表示とインタラクティブ編集**:
    - `QTableView`を用いたスプレッドシート形式での表示、セルやカラムヘッダーの直接編集機能。
    - 右クリックメニューからの行・列の追加、削除機能。
  - **データ変換**:
    - **ワイドからロングへ (`melt`)**: `pandas.melt`を基盤としたGUIツールで、データをTidy Data形式に再構成する機能。
    - **ロングからワイドへ (`pivot`)**: `pandas.pivot_table`を基盤とし、Tidy Dataをクロス集計されたワイド形式に変換する機能を追加。
    - **数式による列作成**: `pandas.eval`を基盤とし、「`'ColumnA' * 100`」のような数式で新しい列を動的に作成する機能。

- **グラフ描画・編集機能**
  - **描画エンジンのSeabornへの統一**: **グラフ描画のコアエンジンを`matplotlib`から`seaborn`へ全面的に移行しました。** これにより、デフォルトでより美しく、学術論文に適した品質のグラフ（散布図、棒グラフ、ペアード散布図など）を少ないコードで描画できるようになり、アプリケーションの目指す方向に大きく前進しました。
  - **グラフタイプ**: ツールバーから**散布図**、**棒グラフ**、**箱ひげ図**、**バイオリンプロット**、**ペアード散布図**、**ヒストグラム**を動的に切り替え可能に。
  - **プロパティパネルによる詳細な編集**:
    - **テキスト**: グラフのタイトル、X/Y軸ラベル、目盛りの**フォントサイズ**を個別に設定可能に。
    - **軸**: X/Y軸の**表示範囲 (Min/Max)** の手動設定、および**対数スケール (Log Scale)** への切り替え機能を追加。グリッド線の表示/非表示も可能に。
    - **フォーマット**: マーカーの種類や色、枠線の色・太さなどを設定可能に。
    - **Prism風スタイル**: グラフの**上と右の枠線（Spine）を非表示にするオプション**を追加。
    - **重ね描き**: 棒グラフ、箱ひげ図、バイオリンプロットに**個別データ点を重ねて表示する機能**を実装。
    - **凡例**: 凡例の**表示位置**をGUIから選択可能に。

- **統計解析とアノテーション機能**
  - **統計アノテーション機能の刷新**: **自前で実装していたアノテーション描画ロジックを廃止し、専門ライブラリ`statannotations`を導入しました。** これにより、t検定やANOVAのp値を元にしたアスタリスク付きブラケットの描画が、**重なりを自動回避しながら堅牢に**行われるようになり、コードの保守性と安定性が劇的に向上しました。
  - **対応のあるt検定**: 2つのペアの列を直接比較する検定機能を追加。
  - **一元配置分散分析 (ANOVA)**: 3群以上の比較に対応。
  - **カイ二乗検定**: `pd.crosstab`を利用し、2つのカテゴリカル変数間の関連を検定する機能を追加。
  - **線形・非線形回帰分析**: 散布図にフィットラインを描画し、凡例に**R²値**を表示。シグモイド曲線（4パラメータロジスティックモデル）のフィッティングにも対応します。

- **エクスポート機能**
  - 作成したグラフを**PNG, JPEG, SVG, PDF**形式で、300 DPIの高解像度で保存する機能を追加 (`File` > `Save Graph As...`)。

---

## 3. 設計思想のブレークスルーと統計解析アーキテクチャの刷新 (2025/08/23)

- **課題の再認識と「グラフファースト」への転換**: 従来の開発過程で、アノテーション機能の実装において根深い問題が明らかになった。それは、**統計検定の実行（`action_handler`）とアノテーションの描画（`graph_manager`）の間で、どのグループペアを比較したかの情報（コンテキスト）が不一致になりやすい**という問題である。特に、サブグループ（hue）やファセットを使った複雑なグラフに対する検定では、`statannotations`ライブラリが要求するペアの形式が動的に変わるため、エラーが頻発し、実装が非常に複雑化していた。

- **新アーキテクチャ：「生成→検定→翻訳」モデルの確立**: この問題を根本的に解決するため、「グラフファースト」の思想をさらに推し進め、すべての統計解析を以下の3ステップで行う、新しい堅牢なアーキテクチャを確立した。

  1. **【生成】検定用グループの生成**:
     - 統計解析が実行されると、まず現在のグラフ設定（X軸、サブグループ）を確認する。
     - サブグループが指定されている場合、`X軸`と`サブグループ`の値を、衝突しないユニークな区切り文字（例: `_#%%%_`）で結合した**内部的な「交互作用グループ」**を動的に生成する。
     - これにより、どんなに複雑なデータ構造も、**必ず一次元のシンプルなグループリスト**として正規化される。

  2. **【検定】統計エンジンの実行**:
     - 正規化された一次元グループを元に、統計検定（ANOVA, t検定など）を実行する。
     - 統計エンジンはデータの由来を気にする必要がなく、常にシンプルな文字列ペアに対するp値を計算することに集中できる。

  3. **【翻訳】アノテーション形式への変換**:
     - 検定結果のシンプルな文字列ペアを、**「翻訳層」** が受け取る。
     - この翻訳層は、現在のグラフ描画コンテキスト（サブグループが使われているか）だけを元に、`statannotations`ライブラリが要求する厳密な形式（例: `(('A', 'c'), ('B', 'd'))`のようなタプルのタプル）へと機械的に変換する。

- **ファセット機能への対応とアーキテクチャの完成**: 上記モデルをさらに拡張し、ファセット化されたグラフにも対応した。
  - **コンテキストの拡張**: `action_handler`は、ファセットの各カテゴリに対してループ処理で検定を行い、生成されるアノテーション辞書に**どのファセットに属するか (`facet_value`)**という情報を記録する。
  - **描画マネージャーの知能化**: `graph_manager`は、各サブプロットを描画する際に、そのサブプロットに対応する`facet_value`を持つアノテーションのみをフィルタリングして描画する。
  - **UIと意図の同期**: ユーザーが`X-Axis`と`Sub-group`に同じ列を指定した場合、「分析ではなく色分けが目的」であるとプログラムが賢く判断し、分析ロジック上はサブグループを無視するが、描画上の色分けは維持する、という直感的な挙動を実現した。
  - この一連の改修により、`KeyError`, `AttributeError`, `ValueError`といった根深いバグを解消し、あらゆるデータ構造に対して統一的で堅牢な分析とアノテーション描画が可能になった。

### **【追記】箱ひげ図実装の反省と今後の指針 (2025/08/23)**

- **課題**: 散布図に箱ひげ図をオーバーレイする機能の実装過程で、アノテーションが一部のグラフ（特に散布図）で表示されなくなる、あるいは「n.s.」が表示されなくなる、という深刻なデグレード（機能低下）が発生した。

- **原因**:
    1. **描画アーキテクチャの不整合**: 散布図の描画方法を、`sns.catplot`ベースから`sns.FacetGrid`を直接生成する方法に変更した。これにより、棒グラフ（`catplot`ベース）と散布図で、グラフオブジェクトの内部構造に微妙な差異が生まれ、共通のアノテーション描画処理が破綻した。
    2. **検定ロジックの意図せぬ変更**: デバッグの過程で、`action_handler`内でp値が0.05未満の結果のみを保存するロジックを加えてしまい、有意差のない結果（n.s.）が描画されなくなった。

- **教訓と今後の指針**:
  - **描画の土台は`catplot`に統一する**: 今後、新しいグラフタイプやオーバーレイ機能を追加する際は、必ず`sns.catplot`を基本の描画キャンバスとして使用する。追加要素は、`catplot`が返した`FacetGrid`オブジェクト (`g`) に対して、`g.map_dataframe()`メソッド等を用いて**後から重ね描き（レイヤー化）する**アプローチを徹底する。これにより、全グラフタイプでオブジェクトの一貫性を保ち、`apply_annotations`のような共通処理の安定性を確保する。
  - **検定と描画の関心を分離する**: `action_handler`は**すべての検定結果をフィルタリングせずに**アノテーションリストに保存することに専念する。p値の解釈（例: "n.s."と表示するか、"*"と表示するか）は、`statannotations`ライブラリが担うべき責務であり、描画を担当する`graph_manager`側で適切にハンドリングする。

---

## 4. これからの実装予定

- **UI/UXの改善**:
  - プロパティパネルをウィンドウ上部の**リボンスタイルUI**に刷新し、データテーブルとグラフの表示領域を最大化する。
  - **（要修正）** データタブで軸などを選択した後に、ツールバーでグラフの種類を`Bar Chart`などに変更すると`RuntimeError`が発生することがある問題の修正。
  - **（要修正）** ファセット利用時に、共通のY軸 (`sharey=True`) を使用している場合、X軸のラベルもグラフ下部中央に一つだけ表示するようにし、論文品質の体裁を整える。
  - **（要再実装）** t検定実行後に、統計量の詳細（t値、p値、各群の平均値やサンプルサイズなど）を表示する結果ダイアログを再実装する。

- **グラフ編集機能のさらなる強化**:
  - **（要修正）** 凡例をグラフの外側に表示した際に、グラフの描画領域が自動でリサイズされるように修正する。
  - **（要修正）** 棒グラフや箱ひげ図などに重ね描きした個別データ点が、カテゴリの中心からずれて表示される問題を修正する。
  - **テキスト・図形追加**: グラフ上の任意の位置にテキストボックスや矢印などを追加・編集する機能。

- **データハンドリング機能の強化**:
  - **フィルタリング**: `Value > 10`のような条件で表示データを絞り込むUI機能。
  - **ソート**: 列ヘッダーのクリックでデータを並び替える機能。

- **統計解析機能の追加**:
  - **二元配置分散分析**など、より高度な統計手法の実装。
  - ノンパラメトリック検定の追加。

- **エクスポート機能の強化**:
  - 表示されているテーブルデータをCSV形式で保存する機能。
