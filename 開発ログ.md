# プロジェクト「Calcite」開発ログ (2025/08/22更新)

## 1. このプロジェクトで実装したいこと

- **直感的な操作性**: `Mito`や`GraphPad Prism`のように、プログラミング知識がなくてもGUI操作だけでデータハンドリング、統計解析、グラフ作成が完結するアプリケーションを目指す。
- **統合環境**: データのインポート、表計算、統計解析、グラフ描画、結果のエクスポートといった一連のワークフローを、シームレスに一つのウィンドウで提供する。
- **論文品質のグラフ**: ユーザーがタイトル、ラベル、色、エラーバーなどを自由に編集でき、学術論文やプレゼンテーションにそのまま利用できる高品質なグラフを作成できる機能。

---

## 2. これまでに実装してきたこと

- **基本UI/UXの改善**
  - **レイアウト変更**: プロパティパネルを画面下部に配置し、データテーブルとグラフの表示領域を拡大。**メインウィンドウを上下分割する`QSplitter`を導入し、起動時のプロパティパネルの高さを最適化**しました。
  - **タブUIの導入**: プロパティパネルを「データ」「フォーマット」「テキスト」「軸」のタブに分割し、設定項目を整理してアクセス性を向上。
  - **高DPI対応**: アプリケーション全体で高解像度ディスプレイをサポートし、グラフやフォントが鮮明に表示されるように改善。

- **データハンドリング機能**
  - **CSVファイルのインポート**: メニューバーからCSVを読み込み、`Pandas`データフレームとして内部で保持。
  - **クリップボードからのペースト**: Excelなどからコピーしたタブ区切りデータをアプリケーションに直接貼り付ける機能を追加 (`Edit` > `Paste`)。
  - **テーブル表示とインタラクティブ編集**:
  - `QTableView`を用いたスプレッドシート形式での表示、セルやカラムヘッダーの直接編集機能。
  - 右クリックメニューからの行・列の追加、削除機能。
  - **データ変換**:
  - **ワイドからロングへ (`melt`)**: `pandas.melt`を基盤としたGUIツールで、データをTidy Data形式に再構成する機能。
  - **ロングからワイドへ (`pivot`)**: `pandas.pivot_table`を基盤とし、Tidy Dataをクロス集計されたワイド形式に変換する機能を追加。
  - **数式による列作成**: `pandas.eval`を基盤とし、「`'ColumnA' * 100`」のような数式で新しい列を動的に作成する機能。

- **グラフ描画・編集機能**
  - **描画エンジンのSeabornへの統一**: **グラフ描画のコアエンジンを`matplotlib`から`seaborn`へ全面的に移行しました。** これにより、デフォルトでより美しく、学術論文に適した品質のグラフ（散布図、棒グラフ、ペアード散布図など）を少ないコードで描画できるようになり、アプリケーションの目指す方向に大きく前進しました。
  - **グラフタイプ**: ツールバーから**散布図**、**棒グラフ**（エラーバー、個別データ点の重ね描き対応）、そして**ペアード散布図**を動的に切り替え可能に。
  - **プロパティパネルによる詳細な編集**:
  - **テキスト**: グラフのタイトル、X/Y軸ラベル、目盛りの**フォントサイズ**を個別に設定可能に。
  - **軸**: X/Y軸の**表示範囲 (Min/Max)** の手動設定、および**対数スケール (Log Scale)** への切り替え機能を追加。グリッド線の表示/非表示も可能に。
  - **フォーマット**: マーカーの種類や色、枠線の色・太さなどを設定可能に。
  - **Prism風スタイル**: グラフの**上と右の枠線（Spine）を非表示にするオプション**を追加。

- **統計解析とアノテーション機能**
  - **統計アノテーション機能の刷新**: **自前で実装していたアノテーション描画ロジックを廃止し、専門ライブラリ`statannotations`を導入しました。** これにより、t検定やANOVAのp値を元にしたアスタリスク付きブラケットの描画が、**重なりを自動回避しながら堅牢に**行われるようになり、コードの保守性と安定性が劇的に向上しました。
  - **t検定のTidy Dataへの完全対応**: ANOVAと同様に**「値の列」と「グループ分けの列」を指定するTidy Data形式に完全対応**し、アプリケーションの思想を統一しました。
  - **対応のあるt検定**: 2つのペアの列を直接比較する検定機能を追加。
  - **一元配置分散分析 (ANOVA)**: 3群以上の比較に対応。
  - **カイ二乗検定**: `pd.crosstab`を利用し、2つのカテゴリカル変数間の関連を検定する機能を追加。
  - **線形・非線形回帰分析**: 散布図にフィットラインを描画し、凡例に**R²値**を表示。シグモイド曲線（4パラメータロジスティックモデル）のフィッティングにも対応します。

- **エクスポート機能**
  - 作成したグラフを**PNG, JPEG, SVG, PDF**形式で、300 DPIの高解像度で保存する機能を追加 (`File` > `Save Graph As...`)。

---

## 3. 設計思想のブレークスルーと「グラフファースト」アーキテクチャの確立 (2025/08/22)

- **課題の再認識**: 従来の「分析フィルタービュー」モデルでは、統計解析を実行するとグラフの表示が自動で切り替わってしまい、「まずデータを触って可視化する」というCalciteのコア哲学を損なう可能性が明らかになった。特に、サブグループ（hue）を持つ複雑なグラフに対するt検定の操作が直感的でないという課題が浮上した。

- **「グラフファースト」への転換**: 上記の課題を解決するため、アーキテクチャを**「グラフファースト」モデル**へと根本的に転換することを決定した。このモデルの思想は以下の通り。
  1. **グラフが常に主役**: `データ`タブで設定されたグラフ（基本ビュー）が、常に表示の基準となる。
  2. **分析はグラフに対して行う**: 統計解析は、**現在表示されているグラフ**を対象に行う。
  3. **アノテーションは重ね描き**: 検定結果のブラケットは、現在のグラフ表示を一切変更せず、その上にオーバーレイとして追加される。

- **実装の達成**: この新しいアーキテクチャに基づき、以下の実装を完了した。
  - **t検定ダイアログの刷新**: 複雑なフィルター形式を廃止し、現在グラフに表示されているX軸とサブグループ（hue）のカテゴリを直接選択して比較できる、UIに刷新した。
  - **コンテキストの一致**: `action_handler`が、新しいダイアログからユーザーの意図を正確に受け取り、`statannotations`が要求する厳密なデータ形式（`box_pair`）を機械的に生成するロジックを確立。これにより、分析と描画のコンテキストが完全に同期し、これまでのアノテーションエラーの根本原因を解決した。
  - **n.s.表示の実装**: 検定結果のp値が0.05以上の場合でも、グラフ上に "n.s." (not significant) と表示する機能を追加し、より科学的な作法に準拠した。
  - **ファセット機能の導入**: `データ`タブで「Facet (Columns / Rows)」を指定することで、Prismのようにグラフを分割して表示する機能の基盤を実装。これにより、3つ以上の因子を持つ複雑なデータセットの可視化に対応した。

---

## 4. これからの実装予定

- **アーキテクチャの展開**:
  - 「グラフファースト」モデルを、ANOVAなど他の統計解析機能にも適用し、操作性を統一する。
- **UI/UXの改善**:
  - プロパティパネルをウィンドウ上部の**リボンスタイルUI**に刷新し、データテーブルとグラフの表示領域を最大化する。
- **グラフ編集機能のさらなる強化**:
  - **テキスト・図形追加**: グラフ上の任意の位置にテキストボックスや矢印などを追加・編集する機能。
- **データハンドリング機能の強化**:
  - **フィルタリング**: `Value > 10`のような条件で表示データを絞り込むUI機能。
  - **ソート**: 列ヘッダーのクリックでデータを並び替える機能。
- **統計解析機能の追加**:
  - **二元配置分散分析**など、より高度な統計手法の実装。
- **エクスポート機能の強化**:
  - 表示されているテーブルデータをCSV形式で保存する機能。
